<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Quiet Archive Uploads</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: ui-monospace, Menlo, Monaco, Consolas, monospace;
      padding: 40px;
      background: #f5f5f5;
      color: #000;
    }

    h1 {
      margin-bottom: 30px;
      font-size: 24px;
    }

    .upload-item {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      display: flex;
      gap: 20px;
      align-items: start;
    }

    .upload-content {
      flex: 1;
    }

    .upload-type {
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: #666;
      margin-bottom: 8px;
    }

    .upload-text {
      font-size: 14px;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .upload-image {
      max-width: 300px;
      max-height: 200px;
      border-radius: 4px;
      margin-bottom: 12px;
    }

    .upload-meta {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }

    .upload-timestamp {
      font-size: 11px;
      color: #999;
    }

    .delete-btn {
      padding: 8px 16px;
      background: #ff5f56;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 12px;
      font-weight: 600;
      transition: background 0.2s;
    }

    .delete-btn:hover {
      background: #e0443e;
    }

    .delete-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 14px;
      color: #666;
    }

    .error {
      background: #ffebee;
      border: 1px solid #ff5f56;
      color: #c62828;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
    }

    .success {
      background: #e8f5e9;
      border: 1px solid #27c93f;
      color: #2e7d32;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
    }

    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
    }

    .refresh-btn {
      padding: 10px 20px;
      background: #000;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
    }

    .refresh-btn:hover {
      background: #333;
    }
  </style>
</head>
<body>
  <h1>Manage Quiet Archive Uploads</h1>

  <div class="controls">
    <button class="refresh-btn" onclick="loadUploads()">Refresh</button>
  </div>

  <div id="messageContainer"></div>
  <div id="uploadsContainer" class="loading">Loading uploads...</div>

  <script>
    let uploads = [];

    async function loadUploads() {
      const container = document.getElementById('uploadsContainer');
      const messageContainer = document.getElementById('messageContainer');
      container.innerHTML = '<div class="loading">Loading uploads...</div>';
      messageContainer.innerHTML = '';

      try {
        const response = await fetch('/api/uploads');
        const data = await response.json();
        uploads = data.uploads || [];

        console.log('Loaded uploads:', uploads);

        if (uploads.length === 0) {
          container.innerHTML = '<div class="loading">No uploads found.</div>';
          return;
        }

        container.innerHTML = '';

        uploads.forEach((upload, index) => {
          const item = document.createElement('div');
          item.className = 'upload-item';

          const content = document.createElement('div');
          content.className = 'upload-content';

          const type = document.createElement('div');
          type.className = 'upload-type';
          type.textContent = upload.type;

          const meta = document.createElement('div');
          meta.className = 'upload-meta';
          meta.innerHTML = `<strong>${upload.name || 'Anonymous'}</strong> • ${upload.city || 'Unknown'}`;

          const timestamp = document.createElement('div');
          timestamp.className = 'upload-timestamp';
          const date = new Date(upload.timestamp);
          timestamp.textContent = `Uploaded: ${date.toLocaleString()} (Timestamp: ${upload.timestamp})`;

          content.appendChild(type);

          if (upload.type === 'text') {
            const text = document.createElement('div');
            text.className = 'upload-text';
            text.textContent = upload.content;
            content.appendChild(text);
          } else if (upload.type === 'image') {
            const img = document.createElement('img');
            img.className = 'upload-image';
            img.src = upload.content;
            content.appendChild(img);

            if (upload.caption) {
              const caption = document.createElement('div');
              caption.className = 'upload-text';
              caption.style.fontStyle = 'italic';
              caption.textContent = upload.caption;
              content.appendChild(caption);
            }
          }

          content.appendChild(meta);
          content.appendChild(timestamp);

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = 'Delete';
          deleteBtn.onclick = () => deleteUpload(upload.timestamp, deleteBtn);

          item.appendChild(content);
          item.appendChild(deleteBtn);

          container.appendChild(item);
        });

      } catch (error) {
        console.error('Error loading uploads:', error);
        container.innerHTML = '<div class="error">Error loading uploads: ' + error.message + '</div>';
      }
    }

    async function deleteUpload(timestamp, button) {
      if (!confirm('Are you sure you want to delete this upload?')) {
        return;
      }

      button.disabled = true;
      button.textContent = 'Deleting...';

      try {
        const response = await fetch(`/api/uploads?action=delete-by-timestamp&timestamp=${timestamp}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          const messageContainer = document.getElementById('messageContainer');
          messageContainer.innerHTML = `<div class="success">✓ Upload deleted successfully! Remaining: ${data.remaining}</div>`;

          // Reload uploads
          setTimeout(() => {
            loadUploads();
          }, 1000);
        } else {
          throw new Error('Delete failed');
        }
      } catch (error) {
        console.error('Error deleting upload:', error);
        const messageContainer = document.getElementById('messageContainer');
        messageContainer.innerHTML = `<div class="error">✗ Error deleting upload: ${error.message}</div>`;
        button.disabled = false;
        button.textContent = 'Delete';
      }
    }

    // Load uploads on page load
    window.addEventListener('DOMContentLoaded', loadUploads);
  </script>
</body>
</html>
